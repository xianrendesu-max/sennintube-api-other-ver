<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>仙人YouTubeビュアー</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: sans-serif;
  background: #1e1e2f;
  color: #fff;
  margin: 0;
}
header {
  background: #27293d;
  padding: 1em;
  text-align: center;
  font-size: 1.5em;
}
.search-box {
  display: flex;
  margin: 1em;
}
.search-box input {
  flex: 1;
  padding: 0.6em;
  border: none;
  border-radius: 6px 0 0 6px;
}
.search-box button {
  padding: 0.6em 1.2em;
  background: #4caf50;
  color: #fff;
  border: none;
  border-radius: 0 6px 6px 0;
  cursor: pointer;
}
.video-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1em;
  padding: 1em;
}
.video-card {
  background: #2d2f44;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  transition: transform .2s;
}
.video-card:hover {
  transform: scale(1.02);
}
.video-card img {
  width: 100%;
  display: block;
}
.video-card .info {
  padding: 0.6em;
}
.video-card .title {
  font-weight: bold;
  font-size: 0.95em;
}
.video-card .channel {
  color: #aaa;
  font-size: 0.85em;
}
#loadMore {
  display: none;
  margin: 1em auto 2em;
  padding: 0.6em 1.4em;
  background: #2196f3;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* ローディング */
#loading {
  display: none;
  text-align: center;
  margin-top: 2em;
}
.spinner {
  width: 42px;
  height: 42px;
  border: 4px solid #555;
  border-top: 4px solid #4caf50;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
#message {
  text-align: center;
  color: #ccc;
  margin: 1em;
}
</style>
</head>

<body>

<header>仙人YouTubeビュアー</header>

<div class="search-box">
  <input id="searchInput" placeholder="検索ワードを入力">
  <button id="searchBtn">検索</button>
</div>

<div id="loading">
  <div class="spinner"></div>
  <div>読み込み中...</div>
</div>

<div id="message"></div>

<div id="videoList" class="video-list"></div>

<button id="loadMore">もっと見る</button>

<script>
/* =========================
   Render Proxy URL
========================= */
const PROXY_URL = "https://YOUR-PROXY.onrender.com";

/* =========================
   Elements
========================= */
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const videoList = document.getElementById("videoList");
const loadMoreBtn = document.getElementById("loadMore");
const loading = document.getElementById("loading");
const message = document.getElementById("message");

/* =========================
   State
========================= */
let query = "";
let page = 1;
let isLoading = false;

/* =========================
   Fetch Videos (Proxy)
========================= */
async function fetchVideos(append) {
  if (isLoading || !query) return;
  isLoading = true;

  loading.style.display = "block";
  message.textContent = "";

  try {
    const res = await fetch(
      `${PROXY_URL}/api/search?q=${encodeURIComponent(query)}&page=${page}`
    );

    if (!res.ok) throw new Error("fetch failed");

    const videos = await res.json();

    if (!append) videoList.innerHTML = "";

    if (!videos || videos.length === 0) {
      message.textContent = "動画を取得できませんでした";
      loadMoreBtn.style.display = "none";
      return;
    }

    renderVideos(videos);
    page++;
    loadMoreBtn.style.display = videos.length >= 20 ? "block" : "none";

  } catch (e) {
    console.error(e);
    message.textContent = "通信エラーが発生しました";
  } finally {
    loading.style.display = "none";
    isLoading = false;
  }
}

/* =========================
   Render
========================= */
function renderVideos(videos) {
  videos.forEach(v => {
    let thumb = "";
    if (v.videoThumbnails && v.videoThumbnails.length > 0) {
      thumb = v.videoThumbnails[v.videoThumbnails.length - 1].url;
      if (thumb.startsWith("/")) {
        thumb = "https://yewtu.be" + thumb;
      }
    }

    const card = document.createElement("div");
    card.className = "video-card";
    card.innerHTML = `
      <img src="${thumb}" loading="lazy">
      <div class="info">
        <div class="title">${v.title}</div>
        <div class="channel">${v.author}</div>
      </div>
    `;
    card.onclick = () => {
      location.href = "watch.html?id=" + v.videoId;
    };
    videoList.appendChild(card);
  });
}

/* =========================
   Events
========================= */
searchBtn.onclick = () => {
  query = searchInput.value.trim();
  if (!query) return;
  page = 1;
  fetchVideos(false);
};

searchInput.addEventListener("keydown", e => {
  if (e.key === "Enter") searchBtn.click();
});

loadMoreBtn.onclick = () => {
  fetchVideos(true);
};
</script>

</body>
</html>
