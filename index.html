<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>仙人YouTubeビュアー</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: sans-serif;
  background: #1e1e2f;
  color: #fff;
  margin: 0;
}
header {
  background: #27293d;
  padding: 1em;
  text-align: center;
  font-size: 1.5em;
}
.search-box {
  display: flex;
  margin: 1em;
}
.search-box input {
  flex: 1;
  padding: 0.5em;
  border: none;
  border-radius: 4px 0 0 4px;
}
.search-box button {
  padding: 0.5em 1em;
  background: #4caf50;
  color: #fff;
  border: none;
  border-radius: 0 4px 4px 0;
  cursor: pointer;
}
.video-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1em;
  padding: 1em;
}
.video-card {
  background: #2d2f44;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
}
.video-card img {
  width: 100%;
}
.video-card .info {
  padding: 0.5em;
}
.video-card .title {
  font-weight: bold;
}
.video-card .channel {
  color: #aaa;
  font-size: 0.9em;
}
#loadMore {
  display: none;
  margin: 1em auto;
  padding: 0.5em 1em;
  background: #2196f3;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* ローディング */
#loading {
  display: none;
  text-align: center;
  margin-top: 2em;
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #555;
  border-top: 4px solid #4caf50;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
#message {
  text-align: center;
  color: #aaa;
  margin-top: 1em;
}
</style>
</head>

<body>

<header>仙人YouTubeビュアー</header>

<div class="search-box">
  <input id="searchInput" placeholder="検索ワードを入力">
  <button id="searchBtn">検索</button>
</div>

<div id="loading">
  <div class="spinner"></div>
  <div>読み込み中...</div>
</div>

<div id="message"></div>

<div id="videoList" class="video-list"></div>

<button id="loadMore">もっと見る</button>

<script>
/* =========================
   Invidious 自動切り替え
========================= */
const INVIDIOUS_LIST = [
  "https://yewtu.be",
  "https://invidious.fdn.fr",
  "https://vid.puffyan.us",
  "https://invidious.tiekoetter.com"
];
let invidiousIndex = 0;

/* =========================
   Elements
========================= */
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const videoList = document.getElementById("videoList");
const loadMoreBtn = document.getElementById("loadMore");
const loading = document.getElementById("loading");
const message = document.getElementById("message");

/* =========================
   State
========================= */
let query = "";
let page = 1;
let isLoading = false;

/* =========================
   Fetch Search
========================= */
async function fetchVideos(append) {
  if (isLoading || !query) return;
  isLoading = true;

  loading.style.display = "block";
  message.textContent = "";

  let videos = null;

  for (let i = 0; i < INVIDIOUS_LIST.length; i++) {
    const base = INVIDIOUS_LIST[invidiousIndex];
    const url = `${base}/api/v1/search?q=${encodeURIComponent(query)}&type=video&page=${page}`;

    try {
      const controller = new AbortController();
      setTimeout(() => controller.abort(), 8000);

      const res = await fetch(url, { signal: controller.signal });
      if (!res.ok) throw new Error();

      videos = await res.json();
      break;
    } catch {
      invidiousIndex = (invidiousIndex + 1) % INVIDIOUS_LIST.length;
    }
  }

  loading.style.display = "none";
  isLoading = false;

  if (!videos || videos.length === 0) {
    if (!append) videoList.innerHTML = "";
    message.textContent = "動画を取得できませんでした";
    return;
  }

  if (!append) videoList.innerHTML = "";
  renderVideos(videos);

  loadMoreBtn.style.display = videos.length === 20 ? "block" : "none";
  page++;
}

/* =========================
   Render
========================= */
function renderVideos(videos) {
  videos.forEach(v => {
    const thumb = v.videoThumbnails?.[0]?.url || "";
    const card = document.createElement("div");
    card.className = "video-card";
    card.innerHTML = `
      <img src="${thumb}">
      <div class="info">
        <div class="title">${v.title}</div>
        <div class="channel">${v.author}</div>
      </div>
    `;
    card.onclick = () => {
      location.href = "watch.html?id=" + v.videoId;
    };
    videoList.appendChild(card);
  });
}

/* =========================
   Events
========================= */
searchBtn.onclick = () => {
  query = searchInput.value.trim();
  if (!query) return;
  page = 1;
  fetchVideos(false);
};

searchInput.addEventListener("keypress", e => {
  if (e.key === "Enter") searchBtn.click();
});

loadMoreBtn.onclick = () => {
  fetchVideos(true);
};
</script>

</body>
</html>
